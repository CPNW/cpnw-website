<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CPNW â€” Education Dashboard</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <link rel="stylesheet" href="../css/style.css" />
</head>
<body>
  <header class="cpnw-header">
    <nav class="navbar navbar-expand-md py-2" aria-label="Primary">
      <div class="container">
        <a
          class="navbar-brand d-flex align-items-center"
          href="../index.html"
          aria-label="CPNW Home"
        >
          <img
            class="cpnw-logo"
            src="../images/CPNWLogoo.png"
            alt="Clinical Placements Northwest"
          />
        </a>
        <div class="d-flex align-items-center gap-2 ms-auto">
          <button
            data-theme-toggle
            type="button"
            class="btn btn-outline-secondary btn-sm btn-cpnw"
            aria-label="Toggle dark and light mode"
          >
            <span class="me-1" aria-hidden="true" data-theme-icon>ðŸŒ™</span>
            <span class="fw-bold" data-theme-label>Dark</span>
          </button>
          <a class="btn btn-sm btn-cpnw btn-cpnw-primary" href="#">Log out</a>
        </div>
      </div>
    </nav>
  </header>

  <main class="py-4 py-lg-5">
    <div class="container">
      <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
        <div>
          <p class="text-uppercase fw-bold cpnw-ls-08 cpnw-fs-75 mb-1">Education</p>
          <h1 class="h3 fw-semibold mb-1">Welcome back, Alex Educator</h1>
          <p class="text-body-secondary mb-0">Hereâ€™s the latest on cohorts, placements, and compliance.</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-cpnw btn-cpnw-primary btn-sm" href="#">Requirements</a>
          <div class="dropdown">
            <button class="btn btn-cpnw btn-cpnw-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              My Account
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#">My Profile</a></li>
              <li><a class="dropdown-item" href="#">Security Settings</a></li>
              <li><a class="dropdown-item" href="#">My Demographics</a></li>
            </ul>
          </div>
          <div class="dropdown">
            <button class="btn btn-cpnw btn-cpnw-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              Admin
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#">Review</a></li>
              <li><a class="dropdown-item" href="#">Assignments</a></li>
              <li><a class="dropdown-item" href="#">Reports</a></li>
              <li><a class="dropdown-item" href="#">Users</a></li>
              <li><a class="dropdown-item" href="#">Background + WATCH Reports</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm btn-cpnw dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            Programs <span class="badge text-bg-secondary align-middle" id="programCount">All</span>
          </button>
          <div class="dropdown-menu dropdown-menu-end p-3" style="min-width: 260px; max-height: 320px; overflow-y: auto;">
            <div class="d-flex gap-2 mb-2">
              <input type="search" class="form-control form-control-sm" placeholder="Search programs" id="programSearch" />
            </div>
            <div class="d-flex gap-2 mb-2">
              <button class="btn btn-outline-secondary btn-sm" type="button" id="programSelectAll">Select all</button>
              <button class="btn btn-outline-secondary btn-sm" type="button" id="programClear">Clear</button>
            </div>
            <div class="d-grid gap-2" id="programFilters"></div>
          </div>
        </div>
        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm btn-cpnw dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            Cohorts <span class="badge text-bg-secondary align-middle" id="cohortCount">All</span>
          </button>
          <div class="dropdown-menu dropdown-menu-end p-3" style="min-width: 260px; max-height: 320px; overflow-y: auto;">
            <div class="d-flex gap-2 mb-2">
              <button class="btn btn-outline-secondary btn-sm" type="button" id="cohortSelectAll">Select all</button>
              <button class="btn btn-outline-secondary btn-sm" type="button" id="cohortClear">Clear</button>
            </div>
            <div class="d-grid gap-2" id="cohortFilters"></div>
          </div>
        </div>
      </div>

      <div class="row g-3 g-lg-4 mb-4" id="programSummary">
        <div class="col-12 col-md-6 col-xl-3">
          <div class="cpnw-shell p-3 h-100">
            <p class="text-body-secondary small mb-1">Approved assignments (current/upcoming)</p>
            <div class="h2 mb-0" id="metricApproved">--</div>
            <p class="small text-success mb-0" id="metricApprovedNote"></p>
          </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
          <div class="cpnw-shell p-3 h-100">
            <p class="text-body-secondary small mb-1">Requirements to review</p>
            <div class="h2 mb-0" id="metricPending">--</div>
            <p class="small text-warning mb-0" id="metricPendingNote"></p>
          </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
          <div class="cpnw-shell p-3 h-100">
            <p class="text-body-secondary small mb-1">Active students</p>
            <div class="h2 mb-0" id="metricActive">--</div>
            <p class="small text-body-secondary mb-0" id="metricActiveNote"></p>
          </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
          <div class="cpnw-shell p-3 h-100">
            <p class="text-body-secondary small mb-1">Students with expiring/expired requirements (30 days)</p>
            <div class="h2 mb-0" id="metricExpiringStudents">--</div>
            <p class="small text-danger mb-0" id="metricExpiringStudentsNote"></p>
          </div>
        </div>
      </div>

      <div class="row g-3 g-lg-4 mb-4">
        <div class="col-12 col-xl-6">
          <div class="cpnw-shell p-3 p-md-4 h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h2 class="h5 fw-bold mb-0">Notifications</h2>
                <p class="text-body-secondary small mb-0">Latest alerts for your cohorts and accounts.</p>
              </div>
              <a class="btn btn-outline-secondary btn-sm btn-cpnw" href="#">View all</a>
            </div>
            <ul class="list-unstyled d-grid gap-2 mb-0">
              <li class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">4 documents pending approval</div>
                  <p class="small text-body-secondary mb-1">Spring BSN cohort â€¢ Due in 2 days</p>
                  <a href="#" class="small text-decoration-none">Review documents</a>
                </div>
                <span class="badge text-bg-warning text-dark">Action</span>
              </li>
              <li class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">Rotation change requested</div>
                  <p class="small text-body-secondary mb-1">Advanced Practicum â€¢ Starts Mar 18</p>
                  <a href="#" class="small text-decoration-none">View request</a>
                </div>
                <span class="badge text-bg-secondary">Review</span>
              </li>
              <li class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">All caught up</div>
                  <p class="small text-body-secondary mb-1">No additional alerts.</p>
                </div>
                <span class="badge text-bg-success">Clear</span>
              </li>
            </ul>
          </div>
        </div>
        <div class="col-12 col-xl-6">
          <div class="cpnw-shell p-3 p-md-4 h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h2 class="h5 fw-bold mb-0">Cohorts</h2>
                <p class="text-body-secondary small mb-0">Filter by program, term, or academic year.</p>
              </div>
            </div>
            <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
              <input type="search" class="form-control form-control-sm" placeholder="Search cohorts or AY" id="cohortSearch" style="max-width: 260px;">
              <div class="form-check ms-auto">
                <input class="form-check-input" type="checkbox" value="" id="cohortShowArchived">
                <label class="form-check-label small" for="cohortShowArchived">Show archived</label>
              </div>
            </div>
            <div style="max-height: 360px; overflow-y: auto;">
              <ul class="list-unstyled d-grid gap-2 mb-0" id="cohortList"></ul>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 g-lg-4">
        <div class="col-12">
          <div class="cpnw-shell p-3 p-md-4 h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h2 class="h5 fw-bold mb-0">Cohort readiness</h2>
                <p class="text-body-secondary small mb-0">Top cohorts and their readiness status.</p>
              </div>
              <button class="btn btn-outline-secondary btn-sm btn-cpnw" type="button" id="readinessToggle">View all</button>
            </div>
            <div class="table-responsive" id="readinessWrapper" style="max-height: 260px; overflow-y: auto;">
              <table class="table table-borderless align-middle mb-0">
                <thead class="text-body-secondary small">
                  <tr>
                    <th scope="col">Cohort</th>
                    <th scope="col">Students</th>
                    <th scope="col">Ready</th>
                    <th scope="col">Pending</th>
                    <th scope="col">Expiring</th>
                  </tr>
                </thead>
                <tbody id="readinessTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>
  <script>
    (() => {
      // Cohort / academic year helpers
      const TODAY = new Date(); // derive AY from the actual current date
      const FALL_START_MONTH = 7; // August (0-based)
      const THIS_YEAR = TODAY.getFullYear();
      const CURRENT_AY_START = TODAY.getMonth() >= FALL_START_MONTH ? THIS_YEAR : THIS_YEAR - 1;
      const AY_VISIBLE_MIN = CURRENT_AY_START - 3;
      const AY_VISIBLE_MAX = CURRENT_AY_START + 1;
      const TERMS = ['Fall', 'Winter', 'Spring', 'Summer'];

      function deriveAY(term, startYear){
        const year = Number(startYear);
        const isFall = term.toLowerCase() === 'fall';
        const ayStart = isFall ? year : year - 1;
        const ayEnd = ayStart + 1;
        return {
          ayStart,
          ayEnd,
          ayLabel: `${ayStart}â€“${ayEnd}`
        };
      }

      function buildCohort({ programId, programName, term, year, students, approvedAssignments, requirementsReview, expiringStudents }){
        const { ayStart, ayEnd, ayLabel } = deriveAY(term, year);
        const label = `${programName} â€“ ${term} ${year}`;
        const archived = ayStart <= CURRENT_AY_START - 4; // older than visible window
        const visibleByDefault = ayStart >= AY_VISIBLE_MIN && ayStart <= AY_VISIBLE_MAX && !archived;
        return {
          programId,
          programName,
          term,
          startYear: year,
          ayStart,
          ayEnd,
          ayLabel,
          label,
          archived,
          visibleByDefault,
          students,
          approvedAssignments,
          requirementsReview,
          expiringStudents
        };
      }

      const programDefs = [
        { id: 'bsn', name: 'BSN', base: 28, aySpan: 4 },
        { id: 'adn', name: 'ADN', base: 24, aySpan: 2 },
        { id: 'surg', name: 'Surgical Technology', base: 20, aySpan: 4 }
      ];

      const termAdjust = { Fall: 3, Winter: 1, Spring: 0, Summer: -2 };

      const cohortSeeds = [];
      programDefs.forEach(p => {
        const ayStarts = Array.from({length: p.aySpan}, (_, i) => CURRENT_AY_START - i);
        ayStarts.forEach(ay => {
          TERMS.forEach(term => {
            const students = Math.max(14, p.base + termAdjust[term] + (CURRENT_AY_START - ay)); // keep counts up
            const approved = Math.min(students, Math.max(10, Math.floor(students * 0.65) + termAdjust[term]));
            const requirementsReview = Math.max(0, students - approved);
            const expiringStudents = Math.min(requirementsReview, Math.max(2, Math.floor(students * 0.2)));
            cohortSeeds.push({
              programId: p.id,
              programName: p.name,
              term,
              year: term === 'Fall' ? ay : ay + 1, // Fall starts AY, others in next calendar year
              students,
              approvedAssignments: approved,
              requirementsReview,
              expiringStudents
            });
          });
        });
      });
      // Add a couple of archived cohorts for restore/visibility examples
      cohortSeeds.push({
        programId: 'bsn',
        programName: 'BSN',
        term: 'Fall',
        year: CURRENT_AY_START - 5,
        students: 16,
        approvedAssignments: 11,
        requirementsReview: 5,
        expiringStudents: 3
      });
      cohortSeeds.push({
        programId: 'adn',
        programName: 'ADN',
        term: 'Spring',
        year: CURRENT_AY_START - 4,
        students: 15,
        approvedAssignments: 10,
        requirementsReview: 5,
        expiringStudents: 3
      });

      const cohorts = cohortSeeds.map(buildCohort);

      function aggregateProgramsFromCohorts(list){
        const map = new Map();
        list.forEach(c => {
          const key = c.programId;
          if (!map.has(key)){
            map.set(key, { id: c.programId, name: c.programName, students: 0, approvedAssignments: 0, requirementsReview: 0, expiringStudents: 0 });
          }
          const entry = map.get(key);
          entry.students += c.students;
          entry.approvedAssignments += c.approvedAssignments;
          entry.requirementsReview += c.requirementsReview;
          entry.expiringStudents += c.expiringStudents;
        });
        return Array.from(map.values());
      }

      function filterCohorts({ search = '', showArchived = false, programIds = [] } = {}){
        const q = search.trim().toLowerCase();
        return cohorts.filter(c => {
          if (programIds.length && !programIds.includes(c.programId)) return false;
          const withinWindow = c.ayStart >= AY_VISIBLE_MIN && c.ayStart <= AY_VISIBLE_MAX;
          const isArchived = !!c.archived;
          const inView = showArchived ? true : (!isArchived && withinWindow);
          if (!inView) return false;
          if (q){
            return (
              c.label.toLowerCase().includes(q) ||
              c.ayLabel.toLowerCase().includes(q) ||
              c.programName.toLowerCase().includes(q)
            );
          }
          return true;
        });
      }

      let programs = aggregateProgramsFromCohorts(cohorts);

      const filters = document.getElementById('programFilters');
      const programCount = document.getElementById('programCount');
      const programSearch = document.getElementById('programSearch');
      const selectAll = document.getElementById('programSelectAll');
      const clearAll = document.getElementById('programClear');
      const metricApproved = document.getElementById('metricApproved');
      const metricApprovedNote = document.getElementById('metricApprovedNote');
      const metricPending = document.getElementById('metricPending');
      const metricPendingNote = document.getElementById('metricPendingNote');
      const metricActive = document.getElementById('metricActive');
      const metricActiveNote = document.getElementById('metricActiveNote');
      const metricExpiringStudents = document.getElementById('metricExpiringStudents');
      const metricExpiringStudentsNote = document.getElementById('metricExpiringStudentsNote');
      const readinessTableBody = document.getElementById('readinessTableBody');
      const readinessWrapper = document.getElementById('readinessWrapper');
      const readinessToggle = document.getElementById('readinessToggle');
      const cohortFilters = document.getElementById('cohortFilters');
      const cohortCount = document.getElementById('cohortCount');
      const cohortSearch = document.getElementById('cohortSearch');
      const cohortShowArchived = document.getElementById('cohortShowArchived');
      const cohortSelectAll = document.getElementById('cohortSelectAll');
      const cohortClear = document.getElementById('cohortClear');
      const cohortList = document.getElementById('cohortList');

      if (!filters) return;

      function renderFilters(filterText = ''){
        filters.innerHTML = '';
        const text = filterText.trim().toLowerCase();
        programs
          .filter(p => !text || p.name.toLowerCase().includes(text))
          .forEach(p => {
            const id = `program-${p.id}`;
            const label = document.createElement('label');
            label.className = 'd-flex align-items-center gap-2 form-check-label';
            label.htmlFor = id;

            const input = document.createElement('input');
            input.type = 'checkbox';
            input.className = 'form-check-input';
            input.id = id;
            input.value = p.id;
            input.checked = true;

            const textSpan = document.createElement('span');
            textSpan.textContent = `${p.name} (${p.students})`;

            label.appendChild(input);
            label.appendChild(textSpan);
            filters.appendChild(label);
          });
      }

      function getSelectedPrograms(){
        const selectedIds = Array.from(filters.querySelectorAll('input:checked')).map(i => i.value);
        return programs.filter(p => selectedIds.includes(p.id));
      }

      function getSelectedCohortLabels(){
        if (!cohortFilters) return [];
        return Array.from(cohortFilters.querySelectorAll('input:checked')).map(i => i.value);
      }

      function renderCohortFilters(filterText = '', showArchived = false, programIds = [], preserveSelection = true){
        if (!cohortFilters) return;
        const existingSelection = preserveSelection ? new Set(getSelectedCohortLabels()) : new Set();
        cohortFilters.innerHTML = '';
        const list = filterCohorts({ search: filterText, showArchived, programIds });
        list.forEach(c => {
          const id = `cohort-${c.label.replace(/\s+/g, '-').toLowerCase()}`;
          const label = document.createElement('label');
          label.className = 'd-flex align-items-center gap-2 form-check-label';
          label.htmlFor = id;

          const input = document.createElement('input');
          input.type = 'checkbox';
          input.className = 'form-check-input';
          input.id = id;
          input.value = c.label;
          input.checked = preserveSelection ? existingSelection.has(c.label) || existingSelection.size === 0 : true;

          const textSpan = document.createElement('span');
          textSpan.textContent = `${c.label} â€¢ AY ${c.ayLabel}`;

          label.appendChild(input);
          label.appendChild(textSpan);
          cohortFilters.appendChild(label);
        });
      }

      function getSelectedCohorts(){
        if (!cohortFilters) return [];
        const selectedLabels = Array.from(cohortFilters.querySelectorAll('input:checked')).map(i => i.value);
        return cohorts.filter(c => selectedLabels.includes(c.label));
      }

      function summarize(){
        const selectedPrograms = getSelectedPrograms();
        const selectedProgramIds = selectedPrograms.map(p => p.id);
        const totalPrograms = selectedPrograms.length || programs.length;
        const currentSearch = cohortSearch ? cohortSearch.value : '';
        const showArchived = cohortShowArchived ? cohortShowArchived.checked : false;
        const visibleCohorts = filterCohorts({ search: currentSearch, showArchived, programIds: selectedProgramIds });
        const activeCohorts = visibleCohorts.filter(c => !c.archived);
        const selectedCohorts = getSelectedCohorts()
          .filter(c => !c.archived)
          .filter(c => !selectedProgramIds.length || selectedProgramIds.includes(c.programId));
        const cohortsForTotals = selectedCohorts.length ? selectedCohorts : activeCohorts;
        const cohortCountSelected = cohortsForTotals.length;
        if (programCount){
          programCount.textContent = totalPrograms === programs.length ? 'All' : totalPrograms || '0';
        }
        const totals = cohortsForTotals.reduce((acc, c) => {
          acc.students += c.students;
          acc.approved += c.approvedAssignments;
          acc.pending += c.requirementsReview;
          acc.expiringStudents += c.expiringStudents;
          return acc;
        }, {students:0, approved:0, pending:0, expiringStudents:0});

        metricApproved.textContent = totals.approved;
        metricApprovedNote.textContent = totalPrograms ? `Across ${totalPrograms} program(s)` : 'Select a program';

        metricPending.textContent = totals.pending;
        metricPendingNote.textContent = totalPrograms ? `Students needing review` : '';

        metricActive.textContent = totals.students;
        metricActiveNote.textContent = totalPrograms ? `Across ${totalPrograms} program(s)` : 'Select a program';

        metricExpiringStudents.textContent = totals.expiringStudents;
        metricExpiringStudentsNote.textContent = totalPrograms ? `Across ${totalPrograms} program(s)` : 'Select a program';

        if (cohortCount){
          cohortCount.textContent = selectedCohorts.length ? cohortCountSelected : activeCohorts.length || 'All';
        }

        renderCohorts(cohortsForTotals);
        renderReadiness(cohortsForTotals);
      }

      function renderCohorts(items){
        if (!cohortList) return;
        cohortList.innerHTML = '';
        const list = items || filterCohorts({
          search: cohortSearch ? cohortSearch.value : '',
          showArchived: cohortShowArchived ? cohortShowArchived.checked : false,
          programIds: getSelectedPrograms().map(p => p.id)
        });
        if (!list.length){
          const li = document.createElement('li');
          li.className = 'text-body-secondary small';
          li.textContent = 'No cohorts match your filters.';
          cohortList.appendChild(li);
          return;
        }
        list.forEach(c => {
          const li = document.createElement('li');
          li.className = 'cpnw-shell p-2 d-flex justify-content-between align-items-center';
          const left = document.createElement('div');
          left.innerHTML = `<div class="fw-semibold">${c.label}</div><div class="small text-body-secondary">AY ${c.ayLabel}</div>`;
          const actions = document.createElement('div');
          actions.className = 'd-flex align-items-center gap-2';
          const badge = document.createElement('span');
          badge.className = `badge ${c.archived ? 'text-bg-secondary' : 'text-bg-success'}`;
          badge.textContent = c.archived ? 'Archived' : 'Active';
          const toggleBtn = document.createElement('button');
          toggleBtn.type = 'button';
          toggleBtn.className = 'btn btn-outline-secondary btn-sm';
          toggleBtn.textContent = c.archived ? 'Restore' : 'Archive';
          toggleBtn.dataset.cohortAction = c.archived ? 'restore' : 'archive';
          toggleBtn.dataset.cohortLabel = c.label;
          actions.appendChild(badge);
          actions.appendChild(toggleBtn);
          li.appendChild(left);
          li.appendChild(actions);
          cohortList.appendChild(li);
        });
      }

      function renderReadiness(list){
        if (!readinessTableBody) return;
        readinessTableBody.innerHTML = '';
        const rows = (list || []).map(c => {
          return `
            <tr>
              <td class="fw-semibold">${c.label}</td>
              <td>${c.students}</td>
              <td><span class="text-success fw-semibold">${c.approvedAssignments}</span></td>
              <td>${c.requirementsReview}</td>
              <td>${c.expiringStudents}</td>
            </tr>
          `;
        }).join('');
        readinessTableBody.innerHTML = rows || '<tr><td colspan="5" class="text-body-secondary small">No cohorts match your filters.</td></tr>';
      }

      renderFilters();
      renderCohortFilters('', cohortShowArchived && cohortShowArchived.checked, [], true);
      summarize();
      filters.addEventListener('change', () => {
        const selectedIds = getSelectedPrograms().map(p => p.id);
        renderCohortFilters(cohortSearch ? cohortSearch.value : '', cohortShowArchived && cohortShowArchived.checked, selectedIds, true);
        summarize();
      });
      if (programSearch){
        programSearch.addEventListener('input', (e) => {
          renderFilters(e.target.value || '');
          summarize();
        });
      }
      if (selectAll){
        selectAll.addEventListener('click', () => {
          filters.querySelectorAll('input[type="checkbox"]').forEach(i => i.checked = true);
          summarize();
        });
      }
      if (clearAll){
        clearAll.addEventListener('click', () => {
          filters.querySelectorAll('input[type="checkbox"]').forEach(i => i.checked = false);
          summarize();
        });
      }

      if (cohortSearch){
        cohortSearch.addEventListener('input', (e) => {
          const selectedIds = getSelectedPrograms().map(p => p.id);
          renderCohortFilters(e.target.value || '', cohortShowArchived && cohortShowArchived.checked, selectedIds, true);
          summarize();
        });
      }
      if (cohortShowArchived){
        cohortShowArchived.addEventListener('change', (e) => {
          const selectedIds = getSelectedPrograms().map(p => p.id);
          renderCohortFilters(cohortSearch ? cohortSearch.value : '', e.target.checked, selectedIds, false);
          summarize();
        });
      }
      if (cohortSelectAll){
        cohortSelectAll.addEventListener('click', () => {
          cohortFilters.querySelectorAll('input[type="checkbox"]').forEach(i => i.checked = true);
          summarize();
        });
      }
      if (cohortClear){
        cohortClear.addEventListener('click', () => {
          cohortFilters.querySelectorAll('input[type="checkbox"]').forEach(i => i.checked = false);
          summarize();
        });
      }
      if (cohortFilters){
        cohortFilters.addEventListener('change', summarize);
      }

      if (cohortList){
        cohortList.addEventListener('click', (e) => {
          const btn = e.target.closest('button[data-cohort-action]');
          if (!btn) return;
          const label = btn.dataset.cohortLabel;
          const action = btn.dataset.cohortAction;
          const cohort = cohorts.find(c => c.label === label);
          if (!cohort) return;
          const confirmMsg = action === 'archive'
            ? `Archive cohort "${label}"? It will be hidden from active views unless you show archived.`
            : `Restore cohort "${label}" to active views?`;
          if (!window.confirm(confirmMsg)) return;
          cohort.archived = action === 'archive';
          // Re-render filters/list/metrics to reflect change
          const selectedIds = getSelectedPrograms().map(p => p.id);
          renderCohortFilters(cohortSearch ? cohortSearch.value : '', cohortShowArchived && cohortShowArchived.checked, selectedIds, true);
          summarize();
        });
      }

      if (readinessToggle && readinessWrapper){
        readinessToggle.addEventListener('click', () => {
          const expanded = readinessWrapper.dataset.expanded === 'true';
          readinessWrapper.dataset.expanded = (!expanded).toString();
          readinessWrapper.style.maxHeight = expanded ? '260px' : '520px';
          readinessToggle.textContent = expanded ? 'View all' : 'Collapse';
        });
      }

      renderCohorts();
    })();
  </script>
  <script src="../js/main.js"></script>
</body>
</html>
