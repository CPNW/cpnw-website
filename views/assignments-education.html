<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CPNW â€” Education Assignments</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <link rel="stylesheet" href="../css/style.css" />
</head>
<body>
  <header class="cpnw-header">
    <nav class="navbar navbar-expand-md py-2" aria-label="Primary">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="../index.html" aria-label="CPNW Home">
          <img class="cpnw-logo" src="../images/CPNWLogoo.png" alt="Clinical Placements Northwest" />
        </a>
        <div class="d-flex align-items-center gap-2 ms-auto">
          <button data-theme-toggle type="button" class="btn btn-outline-secondary btn-sm btn-cpnw" aria-label="Toggle dark and light mode">
            <span class="me-1" aria-hidden="true" data-theme-icon>ðŸŒ™</span>
            <span class="fw-bold" data-theme-label>Dark</span>
          </button>
          <a class="btn btn-sm btn-cpnw btn-cpnw-primary" href="#">Log out</a>
        </div>
      </div>
    </nav>
  </header>

  <main class="py-4 py-lg-5">
    <div class="container position-relative">
      <img src="../images/spores-watermark.png" class="cpnw-spores" alt="" aria-hidden="true" />

      <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
        <a class="btn btn-outline-secondary btn-sm btn-cpnw" href="dashboard-education.html">Back to dashboard</a>
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-cpnw btn-cpnw-primary btn-sm" href="dashboard-education.html">Requirements</a>
          <div class="dropdown">
            <button class="btn btn-cpnw btn-cpnw-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              My Account
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#">My Profile</a></li>
              <li><a class="dropdown-item" href="#">Security Settings</a></li>
              <li><a class="dropdown-item" href="#">My Demographics</a></li>
            </ul>
          </div>
          <div class="dropdown">
            <button class="btn btn-cpnw btn-cpnw-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              Admin
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="review-education.html">Review</a></li>
              <li><a class="dropdown-item" href="assignments-education.html">Assignments</a></li>
              <li><a class="dropdown-item" href="reports-education.html">Education Reports</a></li>
              <li><a class="dropdown-item" href="users.html">Users</a></li>
              <li><a class="dropdown-item" href="#">Background + WATCH Reports</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
        <div>
          <p class="text-uppercase fw-bold cpnw-ls-08 cpnw-fs-75 mb-1">Admin</p>
          <h1 class="h3 fw-semibold mb-1">Education Assignments</h1>
          <p class="text-body-secondary mb-0">Track placements, start dates, and status by cohort.</p>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-12 col-md-3">
          <div class="cpnw-shell p-2 d-flex align-items-center justify-content-between h-100">
            <div class="small text-body-secondary">Assignments</div>
            <div class="btn-group" role="group" aria-label="Assignment range">
              <button type="button" class="btn btn-sm btn-cpnw btn-cpnw-primary" data-range="current">Current/Upcoming</button>
              <button type="button" class="btn btn-sm btn-outline-secondary btn-cpnw" data-range="past">Past</button>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="form-floating">
            <select class="form-select" id="programFilter">
              <option value="">All programs</option>
              <option value="BSN">BSN</option>
              <option value="ADN">ADN</option>
              <option value="Surg Tech">Surg Tech</option>
            </select>
            <label for="programFilter">Program</label>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="form-floating">
            <select class="form-select" id="cohortFilter">
              <option value="">All cohorts</option>
            </select>
            <label for="cohortFilter">Cohort</label>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="form-floating">
            <select class="form-select" id="siteFilter">
              <option value="">All locations</option>
              <option>CPNW Medical Center</option>
              <option>CPNW Healthcare Facility</option>
              <option>Evergreen Health</option>
              <option>Providence NW</option>
            </select>
            <label for="siteFilter">Location</label>
          </div>
        </div>
      </div>

      <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
        <input type="search" class="form-control form-control-sm" id="assignmentSearch" placeholder="Search name, SID/EID, email" style="max-width: 320px;" />
        <div class="d-flex gap-2 ms-auto">
          <button class="btn btn-cpnw btn-cpnw-primary btn-sm" data-filter-status="all">Show all</button>
          <button class="btn btn-outline-secondary btn-sm btn-cpnw" data-filter-status="approved">Approved</button>
          <button class="btn btn-outline-secondary btn-sm btn-cpnw" data-filter-status="pending">Pending</button>
          <button class="btn btn-outline-secondary btn-sm btn-cpnw" data-filter-status="rejected">Rejected</button>
        </div>
      </div>

      <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary btn-sm btn-cpnw" id="showSelected">Show selected</button>
          <button class="btn btn-outline-secondary btn-sm btn-cpnw" id="exportAssignments">Export</button>
          <button class="btn btn-outline-secondary btn-sm btn-cpnw">Assign group</button>
          <button class="btn btn-outline-secondary btn-sm btn-cpnw">Edit group</button>
        </div>
      </div>

      <div class="cpnw-shell p-3 p-md-4">
        <div class="table-responsive">
          <table class="table align-middle mb-0 cpnw-table">
            <thead class="text-body-secondary small position-sticky top-0" style="z-index:2; background: color-mix(in srgb, var(--bs-body-bg) 92%, rgba(20,184,166,.12));">
              <tr>
                <th scope="col"><input type="checkbox" id="selectAllAssignments" /></th>
                <th scope="col">Name</th>
                <th scope="col">SID/EID</th>
                <th scope="col">Role</th>
                <th scope="col">Program</th>
                <th scope="col">Cohort</th>
                <th scope="col">Location</th>
                <th scope="col">Start</th>
                <th scope="col">End</th>
                <th scope="col">Status</th>
                <th scope="col" class="text-end">Add/Edit</th>
              </tr>
            </thead>
            <tbody id="assignmentTableBody"></tbody>
          </table>
        </div>

        <div class="d-flex flex-wrap align-items-center justify-content-between mt-3 gap-2">
          <div class="d-flex align-items-center gap-2">
            <label class="small text-body-secondary mb-0" for="assignmentPageSize">Show</label>
            <select class="form-select form-select-sm" id="assignmentPageSize" style="width:auto;">
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span class="small text-body-secondary">entries</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" type="button" id="assignmentPrevPage">Prev</button>
            <div class="small text-body-secondary" id="assignmentPageInfo">Page 1</div>
            <button class="btn btn-outline-secondary btn-sm" type="button" id="assignmentNextPage">Next</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>
  <script src="../js/main.js"></script>
      <script>
    (function(){
      const TODAY = new Date();
      const FALL_START_MONTH = 7;
      const CURRENT_AY_START = TODAY.getMonth() >= FALL_START_MONTH ? TODAY.getFullYear() : TODAY.getFullYear() - 1;
      const AY_VISIBLE_MIN = CURRENT_AY_START - 3;
      const AY_VISIBLE_MAX = CURRENT_AY_START + 1;
      const TERMS = ['Fall','Winter','Spring','Summer'];

      const programDefs = [
        { id:'BSN', base: 12, aySpan: 2 },
        { id:'ADN', base: 10, aySpan: 2 },
        { id:'Surg Tech', base: 8, aySpan: 2 }
      ];
      const termAdjust = { Fall:3, Winter:1, Spring:0, Summer:-2 };
      const cohortSeeds = [];
      programDefs.forEach(p => {
        Array.from({length:p.aySpan},(_,i)=>CURRENT_AY_START - i).forEach(ay=>{
          TERMS.forEach(term=>{
            const year = term === 'Fall' ? ay : ay + 1;
            const ayStart = term === 'Fall' ? ay : ay - 1;
            const students = Math.max(8, p.base + termAdjust[term] + (CURRENT_AY_START - ay));
            cohortSeeds.push({
              cohortLabel: `${p.id} â€“ ${term} ${year}`,
              program: p.id,
              ayStart,
              students,
              start: `${term} ${year}`
            });
          });
        });
      });
      const cohorts = cohortSeeds.filter(c => c.ayStart >= AY_VISIBLE_MIN && c.ayStart <= AY_VISIBLE_MAX);

      // populate cohort filter
      const cohortFilter = document.getElementById('cohortFilter');
      if (cohortFilter){
        const opts = [''];
        cohorts.forEach(c => opts.push(c.cohortLabel));
        const unique = Array.from(new Set(opts));
        cohortFilter.innerHTML = unique.map(v=>`<option value="${v}">${v || 'All cohorts'}</option>`).join('');
      }

      const programFilter = document.getElementById('programFilter');
      const siteFilter = document.getElementById('siteFilter');
      const assignmentSearch = document.getElementById('assignmentSearch');
      const assignmentTableBody = document.getElementById('assignmentTableBody');
      const assignmentPageSizeSelect = document.getElementById('assignmentPageSize');
      const assignmentPrevPage = document.getElementById('assignmentPrevPage');
      const assignmentNextPage = document.getElementById('assignmentNextPage');
      const assignmentPageInfo = document.getElementById('assignmentPageInfo');
      const selectAllAssignments = document.getElementById('selectAllAssignments');
      const statusButtons = document.querySelectorAll('[data-filter-status]');
      const showSelectedBtn = document.getElementById('showSelected');
      const exportBtn = document.getElementById('exportAssignments');
      const rangeButtons = document.querySelectorAll('[data-range]');

      const locations = ['CPNW Medical Center','CPNW Healthcare Facility','Evergreen Health','Providence NW'];
      const statusPool = ['approved','pending','rejected'];
      const students = [];
      const assignments = [];
      cohorts.forEach((c, idx) => {
        const count = Math.min(10, c.students);
        for (let i=0;i<count;i++){
          const studentId = `${idx+1}-${i+1}`;
          const student = {
            id: studentId,
            name: `Student ${studentId}`,
            sid: String(1000 + idx * 50 + i),
            email: `student${idx+1}${i+1}@demo.cpnw.org`,
            role: 'Student',
            program: c.program,
            cohort: c.cohortLabel,
          };
          students.push(student);

          // Some students have no current/upcoming assignment (wireframe demo)
          const hasCurrentUpcoming = ((idx + i) % 5) !== 0;
          const hasPast = ((idx + i) % 3) !== 0;

          if (hasPast){
            const startPast = new Date(TODAY);
            startPast.setDate(startPast.getDate() - (120 + idx * 3 + i));
            const endPast = new Date(startPast);
            endPast.setDate(endPast.getDate() + 60);
            assignments.push({
              id: `a-past-${studentId}`,
              studentId,
              location: locations[(i + idx) % locations.length],
              start: startPast,
              end: endPast,
              status: statusPool[(i + idx + 1) % statusPool.length]
            });
          }

          if (hasCurrentUpcoming){
            const start = new Date(TODAY);
            start.setDate(start.getDate() + (idx * 8) + i * 2);
            const end = new Date(start);
            end.setDate(end.getDate() + 90);
            assignments.push({
              id: `a-cur-${studentId}`,
              studentId,
              location: locations[(i + idx + 2) % locations.length],
              start,
              end,
              status: statusPool[(i + idx) % statusPool.length]
            });
          }
        }
      });

      const locationAddOptions = ['CPNW Medical Center','CPNW Healthcare Facility'];

      let currentStatus = 'all';
      let currentRange = 'current'; // 'current' | 'past'
      let assignmentPage = 1;
      let assignmentPageSize = Number(assignmentPageSizeSelect?.value || 10);
      const selectedIds = new Set();
      let addDraft = null; // { replaceRowId?: string, afterRowId?: string, studentId: string }
      let editDraft = null; // { rowId: string, assignmentId: string }

      function statusBadge(val){
        if (!val) return '<span class="text-body-secondary">â€”</span>';
        const normalized = val.toLowerCase();
        const map = {
          approved: 'text-bg-success',
          pending: 'text-bg-secondary',
          rejected: 'text-bg-danger'
        };
        const cls = map[normalized] || 'text-bg-secondary';
        const label = normalized.charAt(0).toUpperCase() + normalized.slice(1);
        return `<span class="badge ${cls}">${label}</span>`;
      }

      function isPast(a){
        return a?.end instanceof Date && a.end < TODAY;
      }

      function isCurrentUpcoming(a){
        return a?.end instanceof Date && a.end >= TODAY;
      }

      function listCurrentUpcoming(studentId){
        return assignments
          .filter(a=>a.studentId === studentId && isCurrentUpcoming(a))
          .sort((a,b)=>a.start - b.start);
      }

      function listPast(studentId){
        return assignments
          .filter(a=>a.studentId === studentId && isPast(a))
          .sort((a,b)=>b.end - a.end);
      }

      function fmtDate(d){
        if (!(d instanceof Date)) return '';
        return d.toLocaleDateString();
      }

      function fmtDateInput(d){
        if (!(d instanceof Date)) return '';
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
      }

      function renderAssignments(showOnlySelected = false){
        const q = (assignmentSearch?.value || '').toLowerCase();
        const program = programFilter?.value || '';
        const cohortVal = cohortFilter?.value || '';
        const siteVal = siteFilter?.value || '';
        const rows = [];
        students.forEach(s=>{
          if (program && s.program !== program) return;
          if (cohortVal && s.cohort !== cohortVal) return;
          if (q && !`${s.name} ${s.sid} ${s.email}`.toLowerCase().includes(q)) return;

          const list = currentRange === 'past' ? listPast(s.id) : listCurrentUpcoming(s.id);

          if (currentRange === 'past'){
            if (!list.length) return;
            list.forEach(a=>{
              if (currentStatus !== 'all' && a.status !== currentStatus) return;
              if (siteVal && (a.location || '') !== siteVal) return;
              if (showOnlySelected && !selectedIds.has(a.id)) return;
              rows.push({ rowId: a.id, student: s, assignment: a, kind: 'assignment' });
            });
            return;
          }

          if (!list.length){
            if (currentStatus !== 'all') return;
            if (siteVal) return;
            const rowId = `placeholder-${s.id}`;
            if (showOnlySelected && !selectedIds.has(rowId)) return;
            rows.push({ rowId, student: s, assignment: null, kind: 'placeholder' });
            return;
          }

          list.forEach(a=>{
            if (currentStatus !== 'all' && a.status !== currentStatus) return;
            if (siteVal && (a.location || '') !== siteVal) return;
            if (showOnlySelected && !selectedIds.has(a.id)) return;
            rows.push({ rowId: a.id, student: s, assignment: a, kind: 'assignment' });
          });
        });

        const total = rows.length;
        const totalPages = Math.max(1, Math.ceil(total / assignmentPageSize));
        if (assignmentPage > totalPages) assignmentPage = totalPages;
        const startIdx = (assignmentPage - 1) * assignmentPageSize;
        const endIdx = Math.min(startIdx + assignmentPageSize, total);
        let pageItems = rows.slice(startIdx, endIdx);

        const insertEditorAfter = (afterRowId, studentId) => {
          const index = pageItems.findIndex(r => r.rowId === afterRowId);
          if (index === -1) return false;
          pageItems.splice(index + 1, 0, {
            rowId: `editor-after-${afterRowId}`,
            student: students.find(s=>s.id === studentId),
            assignment: null,
            kind: 'editor-add'
          });
          if (pageItems.length > assignmentPageSize){
            const protectedIds = new Set([afterRowId, `editor-after-${afterRowId}`]);
            for (let i = pageItems.length - 1; i >= 0; i--){
              if (!protectedIds.has(pageItems[i].rowId)){
                pageItems.splice(i, 1);
                break;
              }
            }
          }
          return true;
        };

        if (editDraft && !pageItems.some(r=>r.rowId === editDraft.rowId)) editDraft = null;
        if (addDraft){
          if (addDraft.replaceRowId && !pageItems.some(r=>r.rowId === addDraft.replaceRowId)) addDraft = null;
          if (addDraft.afterRowId){
            const ok = insertEditorAfter(addDraft.afterRowId, addDraft.studentId);
            if (!ok) addDraft = null;
          }
        }

        assignmentTableBody.innerHTML = '';
        pageItems.forEach(({ rowId, student, assignment, kind })=>{
          const tr = document.createElement('tr');
          tr.dataset.rowId = rowId;
          tr.dataset.studentId = student.id;
          const isPlaceholder = kind === 'placeholder';
          const isEditor = kind === 'editor-add';
          const isAddReplace = addDraft?.replaceRowId === rowId;
          const isAddEditor = kind === 'editor-add';
          const isAdding = currentRange === 'current' && (isAddReplace || isAddEditor);
          const isEditing = editDraft?.rowId === rowId;
          const startStr = fmtDate(assignment?.start);
          const endStr = fmtDate(assignment?.end);
          const statusCell = (isPlaceholder || isEditor)
            ? '<span class="text-body-secondary">â€”</span>'
            : statusBadge(assignment.status);

          const actionCell = (function(){
            if (isAdding){
              return `
                <div class="d-flex justify-content-end gap-1">
                  <button class="btn btn-sm btn-outline-secondary" type="button" title="Cancel" data-action="cancel-add">âœ•</button>
                  <button class="btn btn-sm btn-cpnw btn-cpnw-primary" type="button" title="Save" data-action="save-add">ðŸ’¾</button>
                </div>
              `;
            }
            if (isEditing){
              return `
                <div class="d-flex justify-content-end gap-1">
                  <button class="btn btn-sm btn-outline-secondary" type="button" title="Cancel" data-action="cancel-edit">âœ•</button>
                  <button class="btn btn-sm btn-cpnw btn-cpnw-primary" type="button" title="Save" data-action="save-edit">ðŸ’¾</button>
                </div>
              `;
            }
            if (isPlaceholder){
              return `
                <div class="d-flex justify-content-end gap-1">
                  <button class="btn btn-sm btn-outline-secondary" type="button" title="Add assignment" data-action="add-replace" data-row="${rowId}" data-student="${student.id}">ï¼‹</button>
                </div>
              `;
            }
            return `
              <div class="d-flex justify-content-end gap-1">
                <button class="btn btn-sm btn-outline-secondary" type="button" title="Add assignment" data-action="add-after" data-row="${rowId}" data-student="${student.id}">ï¼‹</button>
                <button class="btn btn-sm btn-outline-secondary" type="button" title="Edit assignment" data-action="edit" data-row="${rowId}" data-assignment="${assignment?.id || ''}">âœŽ</button>
                <button class="btn btn-sm btn-outline-danger" type="button" title="Remove" data-action="delete" data-assignment="${assignment?.id || ''}">ðŸ—‘</button>
              </div>
            `;
          })();

          const locationCell = (function(){
            if (isAdding){
              return `
                <select class="form-select form-select-sm" data-field="location">
                  <option value="">Select location</option>
                  ${locationAddOptions.map(l=>`<option value="${l}">${l}</option>`).join('')}
                </select>
              `;
            }
            if (isEditing){
              const opts = Array.from(new Set([...locationAddOptions, ...locations, assignment?.location].filter(Boolean)));
              return `
                <select class="form-select form-select-sm" data-field="location">
                  ${opts.map(l=>`<option value="${l}" ${l===assignment?.location?'selected':''}>${l}</option>`).join('')}
                </select>
              `;
            }
            return assignment?.location || '<span class="text-body-secondary">â€”</span>';
          })();

          const startCell = (isAdding || isEditing)
            ? `<input type="date" class="form-control form-control-sm" data-field="start" value="${isEditing ? fmtDateInput(assignment?.start) : ''}" />`
            : (startStr || '<span class="text-body-secondary">â€”</span>');
          const endCell = (isAdding || isEditing)
            ? `<input type="date" class="form-control form-control-sm" data-field="end" value="${isEditing ? fmtDateInput(assignment?.end) : ''}" />`
            : (endStr || '<span class="text-body-secondary">â€”</span>');

          const checkboxCell = isEditor
            ? ''
            : `<input class="form-check-input assignment-row" type="checkbox" data-id="${rowId}" ${selectedIds.has(rowId) ? 'checked' : ''}>`;

          tr.innerHTML = `
            <td>${checkboxCell}</td>
            <td class="fw-semibold">${student.name}</td>
            <td>${student.sid}</td>
            <td>${student.role}</td>
            <td>${student.program}</td>
            <td>${student.cohort}</td>
            <td>${locationCell}</td>
            <td>${startCell}</td>
            <td>${endCell}</td>
            <td>${statusCell}</td>
            <td class="text-end">${actionCell}</td>
          `;
          assignmentTableBody.appendChild(tr);
        });

        if (assignmentPageInfo){
          assignmentPageInfo.textContent = total ? `Showing ${startIdx + 1}â€“${endIdx} of ${total}` : 'No results';
        }
        if (assignmentPrevPage && assignmentNextPage){
          assignmentPrevPage.disabled = assignmentPage <= 1;
          assignmentNextPage.disabled = endIdx >= total;
        }
      }

      statusButtons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          statusButtons.forEach(b=>{
            b.classList.remove('btn-cpnw','btn-cpnw-primary');
            b.classList.add('btn-outline-secondary');
          });
          btn.classList.remove('btn-outline-secondary');
          btn.classList.add('btn-cpnw','btn-cpnw-primary');
          currentStatus = btn.dataset.filterStatus;
          assignmentPage = 1;
          addDraft = null;
          editDraft = null;
          renderAssignments();
        });
      });

      [assignmentSearch, programFilter, cohortFilter, siteFilter].forEach(el=>{
        if (!el) return;
        const fn = () => { assignmentPage = 1; renderAssignments(); };
        el.addEventListener(el.tagName === 'SELECT' ? 'change' : 'input', fn);
      });

      rangeButtons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          rangeButtons.forEach(b=>{
            b.classList.remove('btn-cpnw','btn-cpnw-primary');
            b.classList.add('btn-outline-secondary');
          });
          btn.classList.remove('btn-outline-secondary');
          btn.classList.add('btn-cpnw','btn-cpnw-primary');
          currentRange = btn.dataset.range;
          assignmentPage = 1;
          addDraft = null;
          editDraft = null;
          renderAssignments();
        });
      });

      if (assignmentPageSizeSelect){
        assignmentPageSizeSelect.addEventListener('change', ()=>{
          assignmentPageSize = Number(assignmentPageSizeSelect.value || 10);
          assignmentPage = 1;
          renderAssignments();
        });
      }

      assignmentPrevPage?.addEventListener('click', ()=>{
        if (assignmentPage > 1){
          assignmentPage -= 1;
          renderAssignments();
        }
      });
      assignmentNextPage?.addEventListener('click', ()=>{
        assignmentPage += 1;
        renderAssignments();
      });

      document.addEventListener('click', (e)=>{
        if (e.target.matches('.assignment-row')){
          const id = e.target.dataset.id;
          if (id){
            if (e.target.checked) selectedIds.add(id);
            else selectedIds.delete(id);
          }
        }

        const actionBtn = e.target.closest('[data-action]');
        if (actionBtn){
          const action = actionBtn.dataset.action;
          if (action === 'add-replace'){
            if (currentRange !== 'current') return;
            const rowId = actionBtn.dataset.row;
            const studentId = actionBtn.dataset.student;
            if (!rowId || !studentId) return;
            addDraft = { replaceRowId: rowId, studentId };
            editDraft = null;
            renderAssignments();
          }

          if (action === 'add-after'){
            if (currentRange !== 'current') return;
            const rowId = actionBtn.dataset.row;
            const studentId = actionBtn.dataset.student;
            if (!rowId || !studentId) return;
            addDraft = { afterRowId: rowId, studentId };
            editDraft = null;
            renderAssignments();
          }

          if (action === 'edit'){
            const rowId = actionBtn.dataset.row;
            const assignmentId = actionBtn.dataset.assignment;
            if (!rowId || !assignmentId) return;
            editDraft = { rowId, assignmentId };
            addDraft = null;
            renderAssignments();
          }

          if (action === 'delete'){
            const assignmentId = actionBtn.dataset.assignment;
            if (!assignmentId) return;
            const ok = confirm('Remove this assignment?');
            if (!ok) return;
            const idx = assignments.findIndex(a=>a.id === assignmentId);
            if (idx !== -1) assignments.splice(idx, 1);
            if (editDraft?.assignmentId === assignmentId) editDraft = null;
            renderAssignments();
          }

          if (action === 'cancel-add'){
            addDraft = null;
            renderAssignments();
          }

          if (action === 'cancel-edit'){
            editDraft = null;
            renderAssignments();
          }

          if (action === 'save-add'){
            const row = actionBtn.closest('tr');
            const loc = row?.querySelector('[data-field="location"]')?.value || '';
            const startVal = row?.querySelector('[data-field="start"]')?.value || '';
            const endVal = row?.querySelector('[data-field="end"]')?.value || '';
            if (!loc || !startVal || !endVal){
              alert('Please choose a location and enter both start and end dates.');
              return;
            }
            const start = new Date(`${startVal}T00:00:00`);
            const end = new Date(`${endVal}T00:00:00`);
            if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime()) || end < start){
              alert('Please enter a valid date range (end date must be on/after start date).');
              return;
            }
            const studentId = row?.dataset.studentId;
            if (!studentId){
              alert('Unable to save: missing student id.');
              return;
            }
            const id = `a-added-${studentId}-${Date.now()}`;
            assignments.push({ id, studentId, location: loc, start, end, status: 'pending' });
            addDraft = null;
            renderAssignments();
          }

          if (action === 'save-edit'){
            const row = actionBtn.closest('tr');
            const loc = row?.querySelector('[data-field="location"]')?.value || '';
            const startVal = row?.querySelector('[data-field="start"]')?.value || '';
            const endVal = row?.querySelector('[data-field="end"]')?.value || '';
            if (!loc || !startVal || !endVal){
              alert('Please choose a location and enter both start and end dates.');
              return;
            }
            const start = new Date(`${startVal}T00:00:00`);
            const end = new Date(`${endVal}T00:00:00`);
            if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime()) || end < start){
              alert('Please enter a valid date range (end date must be on/after start date).');
              return;
            }
            const assignmentId = editDraft?.assignmentId;
            const a = assignments.find(x=>x.id === assignmentId);
            if (!a){
              alert('Unable to save: assignment not found.');
              return;
            }
            a.location = loc;
            a.start = start;
            a.end = end;
            editDraft = null;
            renderAssignments();
          }
        }
      });

      selectAllAssignments?.addEventListener('change', ()=>{
        const check = selectAllAssignments.checked;
        document.querySelectorAll('.assignment-row').forEach(cb=>{
          cb.checked = check;
          const id = cb.dataset.id;
          if (id){
            if (check) selectedIds.add(id);
            else selectedIds.delete(id);
          }
        });
      });

      showSelectedBtn?.addEventListener('click', ()=>{
        assignmentPage = 1;
        addDraft = null;
        editDraft = null;
        renderAssignments(true);
      });

      exportBtn?.addEventListener('click', ()=>{
        alert(`Exporting ${selectedIds.size} selected assignments (demo).`);
      });

      renderAssignments();
    })();
  </script>
</body>
</html>
