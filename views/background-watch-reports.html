<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CPNW â€” Background + WATCH Reports</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <link rel="stylesheet" href="../css/style.css" />
</head>
<body>
  <header class="cpnw-header">
    <nav class="navbar navbar-expand-md py-2" aria-label="Primary">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="../index.html" aria-label="CPNW Home">
          <img class="cpnw-logo" src="../images/CPNWLogoo.png" alt="Clinical Placements Northwest" />
        </a>
        <div class="d-flex align-items-center gap-2 ms-auto">
          <button data-theme-toggle type="button" class="btn btn-outline-secondary btn-sm btn-cpnw" aria-label="Toggle dark and light mode">
            <span class="me-1" aria-hidden="true" data-theme-icon>ðŸŒ™</span>
            <span class="fw-bold" data-theme-label>Dark</span>
          </button>
          <a class="btn btn-sm btn-cpnw btn-cpnw-primary" href="../index.html" data-logout-trigger>Log out</a>
        </div>
      </div>
    </nav>
  </header>

  <main class="py-4 py-lg-5">
    <div class="container position-relative">
      <img src="../images/spores-watermark.png" class="cpnw-spores" alt="" aria-hidden="true" />

      <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
        <a class="btn btn-outline-secondary btn-sm btn-cpnw" href="dashboard-education.html">Back to dashboard</a>
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-cpnw btn-cpnw-primary btn-sm" href="requirements-education.html">Requirements</a>
          <div class="dropdown">
            <button class="btn btn-cpnw btn-cpnw-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              My Account
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="my-profile.html">My Profile</a></li>
              <li><a class="dropdown-item" href="security-settings.html">Security Settings</a></li>
            </ul>
          </div>
          <div class="dropdown">
            <button class="btn btn-cpnw btn-cpnw-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              Admin
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="review-education.html">Review</a></li>
              <li><a class="dropdown-item" href="assignments-education.html">Assignments</a></li>
              <li><a class="dropdown-item" href="reports-education.html">Education Reports</a></li>
              <li><a class="dropdown-item" href="users.html">Users</a></li>
              <li><a class="dropdown-item" href="background-watch-reports.html">Background + WATCH Reports</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="d-flex flex-wrap justify-content-between align-items-start mb-4 gap-3">
        <div>
          <p class="text-uppercase fw-bold cpnw-ls-08 cpnw-fs-75 mb-1">Admin</p>
          <h1 class="h3 fw-semibold mb-1">Background + WATCH Reports</h1>
          <p class="text-body-secondary mb-0">Initiate Checkr background checks and CPNW WATCH reports, and track status.</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-outline-secondary btn-sm btn-cpnw" type="button" id="clearFiltersBtn">Clear filters</button>
        </div>
      </div>

      <div class="row g-3 align-items-end mb-3">
        <div class="col-12 col-md-4">
          <div class="form-floating">
            <input type="search" class="form-control" id="bwSearch" placeholder="Search student, email, or cohort" />
            <label for="bwSearch">Search</label>
          </div>
        </div>
        <div class="col-12 col-md-2">
          <div class="form-floating">
            <select class="form-select" id="bwProgram">
              <option value="">All programs</option>
              <option value="BSN">BSN</option>
              <option value="ADN">ADN</option>
              <option value="Surg Tech">Surg Tech</option>
            </select>
            <label for="bwProgram">Program</label>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="form-floating">
            <select class="form-select" id="bwCohort">
              <option value="">All cohorts</option>
            </select>
            <label for="bwCohort">Cohort</label>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="form-floating">
            <select class="form-select" id="bwStatus">
              <option value="">Any status</option>
              <option value="na">N/A</option>
              <option value="sent">Sent</option>
              <option value="in-progress">In progress</option>
              <option value="complete">Complete</option>
              <option value="issue">Issue</option>
            </select>
            <label for="bwStatus">Status</label>
          </div>
        </div>
      </div>

      <div class="cpnw-shell p-0 overflow-hidden">
        <div class="d-flex flex-wrap justify-content-between align-items-center p-3 gap-2 border-bottom">
          <div class="small text-body-secondary">
            <span class="fw-semibold" id="bwSelectedCount">0</span> selected
          </div>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-outline-secondary btn-sm btn-cpnw" type="button" id="initiateSingleBtn" disabled>
              Initiate selected
            </button>
            <button class="btn btn-cpnw btn-cpnw-primary btn-sm" type="button" id="initiateGroupBtn" disabled>
              Initiate Group
            </button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table align-middle mb-0 cpnw-table">
            <thead class="text-body-secondary small">
              <tr>
                <th scope="col" style="width: 44px;"><input type="checkbox" class="form-check-input" id="bwSelectAll" /></th>
                <th scope="col">
                  <button class="btn btn-link p-0 text-decoration-none sort" data-sort="name">Student</button>
                </th>
                <th scope="col" class="d-none d-lg-table-cell">
                  <button class="btn btn-link p-0 text-decoration-none sort" data-sort="program">Program</button>
                </th>
                <th scope="col" class="d-none d-xl-table-cell">
                  <button class="btn btn-link p-0 text-decoration-none sort" data-sort="cohort">Cohort</button>
                </th>
                <th scope="col">
                  <div class="d-flex flex-column">
                    <span class="fw-semibold text-body-secondary">Checkr</span>
                    <span class="text-body-secondary">Background Check</span>
                  </div>
                </th>
                <th scope="col" class="text-nowrap">
                  <button class="btn btn-link p-0 text-decoration-none sort" data-sort="checkrModified">Modified</button>
                </th>
                <th scope="col">
                  <div class="d-flex flex-column">
                    <span class="fw-semibold text-body-secondary">CPNW</span>
                    <span class="text-body-secondary">WATCH</span>
                  </div>
                </th>
                <th scope="col" class="text-nowrap">
                  <button class="btn btn-link p-0 text-decoration-none sort" data-sort="watchModified">Modified</button>
                </th>
                <th scope="col" class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="bwTableBody"></tbody>
          </table>
        </div>
        <div class="d-flex flex-wrap justify-content-between align-items-center p-3 gap-2 border-top">
          <div class="small text-body-secondary" id="bwPageInfo">Page 1</div>
          <div class="d-flex align-items-center gap-2">
            <label class="small text-body-secondary mb-0" for="bwPageSize">Show</label>
            <select class="form-select form-select-sm" id="bwPageSize" style="width: auto;">
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span class="small text-body-secondary">entries</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm btn-cpnw" type="button" id="bwPrev">Prev</button>
            <button class="btn btn-outline-secondary btn-sm btn-cpnw" type="button" id="bwNext">Next</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="cpnw-footer py-3 py-lg-4">
    <div class="container">
      <div class="cpnw-footer-inner text-center">
        <div class="small text-body-secondary">
          Copyright Â© 2024 Clinical Placements Northwest | All rights reserved.
          <a class="text-decoration-none" href="../terms-privacy.html">Terms of Use and Privacy Policy</a>
        </div>
        <div class="mt-2">
          <button type="button" class="btn btn-cpnw btn-cpnw-primary btn-sm" data-contact-trigger>
            Contact Us
          </button>
        </div>
      </div>
    </div>
  </footer>

      <div class="modal fade" id="initiateModal" tabindex="-1" aria-labelledby="initiateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title" id="initiateModalLabel">Initiate checks</h5>
            <p class="small text-body-secondary mb-0" id="initiateModalDesc">Choose Checkr and/or WATCH. Only one Checkr type can be initiated.</p>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning d-none" role="alert" id="initiateError"></div>

          <div class="row g-3">
            <div class="col-12 col-lg-7">
              <div class="cpnw-shell p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="fw-semibold">Selected students</div>
                  <div class="small text-body-secondary"><span id="initiateCount">0</span> selected</div>
                </div>
                <div class="small text-body-secondary mb-2">Tip: use the checkboxes in the table to select multiple students.</div>
                <div class="border rounded p-2 bg-body-tertiary" style="max-height: 240px; overflow-y: auto;">
                  <ul class="list-unstyled mb-0" id="initiateList"></ul>
                </div>
              </div>
            </div>
            <div class="col-12 col-lg-5">
              <div class="cpnw-shell p-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="" id="initiateCheckr" />
                  <label class="form-check-label fw-semibold" for="initiateCheckr">
                    Initiate Checkr Background Check
                  </label>
                  <div class="form-text">Choose one: Standard (SSN) or International/Nonâ€‘SSN.</div>
                </div>

                <div class="mt-2 ps-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="checkrType" id="checkrStandard" value="standard" disabled />
                    <label class="form-check-label" for="checkrStandard">Standard Checkr (SSN)</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="checkrType" id="checkrInternational" value="international" disabled />
                    <label class="form-check-label" for="checkrInternational">International / Nonâ€‘SSN</label>
                  </div>
                </div>

                <hr class="my-3" />

                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="" id="initiateWatch" />
                  <label class="form-check-label fw-semibold" for="initiateWatch">
                    Initiate CPNW WATCH
                  </label>
                  <div class="form-text">WATCH can be initiated with or without a Checkr check.</div>
                </div>
              </div>

              <div class="mt-2 small text-body-secondary">
                Note: This is a demo workflow; initiation updates the table state locally.
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-outline-secondary btn-cpnw" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-cpnw btn-cpnw-primary" id="initiateConfirmBtn">Initiate</button>
        </div>
      </div>
    </div>
  </div>

  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>
  <script src="../js/main.js?v=20251214-2"></script>
  <script>
    (function(){
      const STORAGE_KEY = 'cpnw-bgc-watch-v1';
      const TODAY = new Date();
      const FALL_START_MONTH = 7;
      const CURRENT_AY_START = TODAY.getMonth() >= FALL_START_MONTH ? TODAY.getFullYear() : TODAY.getFullYear() - 1;
      const AY_VISIBLE_MIN = CURRENT_AY_START - 3;
      const AY_VISIBLE_MAX = CURRENT_AY_START + 1;
      const TERMS = ['Fall','Winter','Spring','Summer'];

      const tableBody = document.getElementById('bwTableBody');
      const searchInput = document.getElementById('bwSearch');
      const programSelect = document.getElementById('bwProgram');
      const cohortSelect = document.getElementById('bwCohort');
      const statusSelect = document.getElementById('bwStatus');
      const selectAll = document.getElementById('bwSelectAll');
      const pageInfo = document.getElementById('bwPageInfo');
      const pageSizeSelect = document.getElementById('bwPageSize');
      const prevBtn = document.getElementById('bwPrev');
      const nextBtn = document.getElementById('bwNext');
      const clearFiltersBtn = document.getElementById('clearFiltersBtn');
      const selectedCountEl = document.getElementById('bwSelectedCount');
      const initiateSingleBtn = document.getElementById('initiateSingleBtn');
      const initiateGroupBtn = document.getElementById('initiateGroupBtn');

      const modalEl = document.getElementById('initiateModal');
      const modal = modalEl ? new bootstrap.Modal(modalEl) : null;
      const initiateModalLabel = document.getElementById('initiateModalLabel');
      const initiateModalDesc = document.getElementById('initiateModalDesc');
      const initiateList = document.getElementById('initiateList');
      const initiateCount = document.getElementById('initiateCount');
      const initiateError = document.getElementById('initiateError');
      const initiateCheckr = document.getElementById('initiateCheckr');
      const initiateWatch = document.getElementById('initiateWatch');
      const checkrStandard = document.getElementById('checkrStandard');
      const checkrInternational = document.getElementById('checkrInternational');
      const confirmBtn = document.getElementById('initiateConfirmBtn');

      const selectedEmails = new Set();
      let page = 1;
      let pageSize = Number(pageSizeSelect?.value || 10);
      let sortState = { field:'name', dir:'asc' };
      let currentModalEmails = [];
      let currentModalMode = 'single';

      function isoDate(d){
        const date = d instanceof Date ? d : new Date(d);
        if (Number.isNaN(date.getTime())) return '';
        return date.toISOString().slice(0, 10);
      }

      function prettyDate(val){
        if (!val) return '<span class="text-body-secondary">â€”</span>';
        const date = new Date(val);
        if (Number.isNaN(date.getTime())) return '<span class="text-body-secondary">â€”</span>';
        return date.toLocaleDateString(undefined, { year:'numeric', month:'numeric', day:'numeric' });
      }

      function loadJSON(key, fallback){
        try{
          const raw = localStorage.getItem(key);
          if (!raw) return fallback;
          const val = JSON.parse(raw);
          return val ?? fallback;
        }catch{
          return fallback;
        }
      }

      function saveJSON(key, value){
        try{
          localStorage.setItem(key, JSON.stringify(value));
        }catch{
          // ignore
        }
      }

      function getStore(){
        const store = loadJSON(STORAGE_KEY, {});
        if (!store || typeof store !== 'object' || Array.isArray(store)) return {};
        return store;
      }

      function setStore(next){
        saveJSON(STORAGE_KEY, next);
      }

      function getRecord(email){
        const key = String(email || '').trim().toLowerCase();
        if (!key) return null;
        const store = getStore();
        const record = store[key];
        if (!record || typeof record !== 'object') return {
          checkr: { type:'', status:'', modified:'' },
          watch: { status:'', modified:'' }
        };
        return {
          checkr: {
            type: String(record.checkr?.type || ''),
            status: String(record.checkr?.status || ''),
            modified: String(record.checkr?.modified || '')
          },
          watch: {
            status: String(record.watch?.status || ''),
            modified: String(record.watch?.modified || '')
          }
        };
      }

      function patchRecord(email, patch){
        const key = String(email || '').trim().toLowerCase();
        if (!key) return;
        const store = getStore();
        const current = getRecord(key);
        const next = {
          checkr: { ...current.checkr, ...(patch.checkr || {}) },
          watch: { ...current.watch, ...(patch.watch || {}) }
        };
        store[key] = next;
        setStore(store);
      }

      function clearRecord(email){
        const key = String(email || '').trim().toLowerCase();
        if (!key) return;
        const store = getStore();
        delete store[key];
        setStore(store);
      }

      function statusBadge(status){
        const normalized = String(status || '').toLowerCase();
        const map = {
          '': { text:'N/A', cls:'text-bg-secondary' },
          'sent': { text:'Sent', cls:'text-bg-success' },
          'in-progress': { text:'In progress', cls:'text-bg-info text-dark' },
          'complete': { text:'Complete', cls:'text-bg-success' },
          'issue': { text:'Issue', cls:'text-bg-danger' }
        };
        const entry = map[normalized] || { text: status, cls:'text-bg-secondary' };
        return `<span class="badge ${entry.cls}">${entry.text}</span>`;
      }

      function checkrTypeLabel(type){
        if (type === 'standard') return 'Standard';
        if (type === 'international') return 'International/Nonâ€‘SSN';
        return '';
      }

      // Cohorts (match other admin pages)
      const programDefs = [
        { id:'BSN', base: 12, aySpan: 2 },
        { id:'ADN', base: 10, aySpan: 2 },
        { id:'Surg Tech', base: 8, aySpan: 2 }
      ];
      const termAdjust = { Fall:3, Winter:1, Spring:0, Summer:-2 };
      const cohortSeeds = [];
      programDefs.forEach(p => {
        Array.from({length:p.aySpan},(_,i)=>CURRENT_AY_START - i).forEach(ay=>{
          TERMS.forEach(term=>{
            const year = term === 'Fall' ? ay : ay + 1;
            const ayStart = term === 'Fall' ? ay : ay - 1;
            const students = Math.max(8, p.base + termAdjust[term] + (CURRENT_AY_START - ay));
            cohortSeeds.push({
              cohortLabel: `${p.id} â€“ ${term} ${year}`,
              program: p.id,
              ayStart,
              students
            });
          });
        });
      });

      let cohorts = cohortSeeds.filter(c => c.ayStart >= AY_VISIBLE_MIN && c.ayStart <= AY_VISIBLE_MAX);
      const cohortAPI = window.CPNW && window.CPNW.cohorts ? window.CPNW.cohorts : null;
      const membershipCounts = (cohortAPI && typeof cohortAPI.getMembershipCounts === 'function') ? cohortAPI.getMembershipCounts() : {};
      if (cohortAPI){
        cohorts = cohorts.map(c => {
          const seedKey = typeof cohortAPI.seedKeyForLabel === 'function' ? cohortAPI.seedKeyForLabel(c.cohortLabel) : `seed:${c.cohortLabel}`;
          const delta = membershipCounts[seedKey] || 0;
          return { ...c, students: c.students + delta };
        });
        if (typeof cohortAPI.listCustomCohortsLegacy === 'function'){
          const custom = cohortAPI.listCustomCohortsLegacy({ ayMin: AY_VISIBLE_MIN, ayMax: AY_VISIBLE_MAX });
          cohorts = cohorts.concat(custom);
        }
      }

      if (cohortSelect){
        const opts = ['', '__unassigned__', ...cohorts.map(c => c.cohortLabel)];
        const unique = Array.from(new Set(opts));
        cohortSelect.innerHTML = unique.map(val => {
          if (!val) return `<option value="">All cohorts</option>`;
          if (val === '__unassigned__') return `<option value="__unassigned__">Unassigned</option>`;
          return `<option value="${val}">${val}</option>`;
        }).join('');
      }

      // Build roster
      const roster = [];
      cohorts.forEach((c, idx) => {
        const count = Math.min(12, c.students);
        for (let i = 0; i < count; i++){
          const email = `student${idx+1}${i+1}@demo.cpnw.org`;
          let cohortLabel = c.cohortLabel;
          if (cohortAPI && typeof cohortAPI.getUserCohortLabel === 'function'){
            const override = cohortAPI.getUserCohortLabel(email);
            if (override !== null && override !== undefined){
              cohortLabel = override;
            }
          }
          const record = getRecord(email);
          roster.push({
            name: `Student ${idx+1}-${i+1}`,
            email,
            program: c.program,
            cohort: cohortLabel,
            checkr: record.checkr,
            watch: record.watch
          });
        }
      });

      function setInitiateError(message){
        if (!initiateError) return;
        if (!message){
          initiateError.classList.add('d-none');
          initiateError.textContent = '';
          return;
        }
        initiateError.classList.remove('d-none');
        initiateError.textContent = message;
      }

      function updateSelectionUI(){
        const count = selectedEmails.size;
        if (selectedCountEl) selectedCountEl.textContent = String(count);
        if (initiateSingleBtn) initiateSingleBtn.disabled = count !== 1;
        if (initiateGroupBtn) initiateGroupBtn.disabled = count <= 1;
      }

      function getActiveCheckrType(){
        if (checkrStandard && checkrStandard.checked) return 'standard';
        if (checkrInternational && checkrInternational.checked) return 'international';
        return '';
      }

      function setCheckrTypeEnabled(enabled){
        [checkrStandard, checkrInternational].forEach(el => {
          if (!el) return;
          el.disabled = !enabled;
          if (!enabled) el.checked = false;
        });
      }

      function openInitiate(emails, mode = 'single'){
        if (!modal) return;
        currentModalMode = mode === 'group' ? 'group' : 'single';
        currentModalEmails = Array.from(new Set((emails || []).filter(Boolean)));
        setInitiateError('');
        if (initiateCheckr) initiateCheckr.checked = true;
        if (initiateWatch) initiateWatch.checked = true;
        setCheckrTypeEnabled(true);
        if (checkrStandard) checkrStandard.checked = true;
        if (initiateCount) initiateCount.textContent = String(currentModalEmails.length);
        if (initiateModalLabel){
          initiateModalLabel.textContent = currentModalMode === 'group' ? 'Initiate group checks' : 'Initiate checks';
        }
        if (initiateModalDesc){
          initiateModalDesc.textContent = currentModalMode === 'group'
            ? 'Choose Checkr and/or WATCH for the selected students. Only one Checkr type can be initiated.'
            : 'Choose Checkr and/or WATCH. Only one Checkr type can be initiated.';
        }
        if (initiateList){
          const rows = currentModalEmails.map(email => {
            const person = roster.find(p => p.email === email);
            const label = person ? `${person.name} (${person.email})` : email;
            return `<li class="py-1 border-bottom">${label}</li>`;
          });
          initiateList.innerHTML = rows.join('') || '<li class="text-body-secondary">No students selected.</li>';
        }
        modal.show();
      }

      function matchesStatus(person, filter){
        if (!filter) return true;
        const f = String(filter).toLowerCase();
        const checkr = String(person.checkr?.status || '').toLowerCase();
        const watch = String(person.watch?.status || '').toLowerCase();
        if (f === 'na'){
          return !checkr && !watch;
        }
        return checkr === f || watch === f;
      }

      function normalizeSortVal(field, item){
        switch(field){
          case 'checkrModified': return item.checkr?.modified ? new Date(item.checkr.modified).getTime() : 0;
          case 'watchModified': return item.watch?.modified ? new Date(item.watch.modified).getTime() : 0;
          default: return String(item[field] ?? '').toLowerCase();
        }
      }

      function render(){
        if (!tableBody) return;
        const q = (searchInput?.value || '').toLowerCase().trim();
        const program = programSelect?.value || '';
        const cohort = cohortSelect?.value || '';
        const status = statusSelect?.value || '';

        const filtered = roster.filter(p => {
          if (program && p.program !== program) return false;
          if (cohort){
            if (cohort === '__unassigned__'){
              if ((p.cohort || '').trim()) return false;
            }else{
              if (p.cohort !== cohort) return false;
            }
          }
          if (!matchesStatus(p, status)) return false;
          if (q){
            const hay = `${p.name} ${p.email} ${p.program} ${p.cohort}`.toLowerCase();
            if (!hay.includes(q)) return false;
          }
          return true;
        });

        filtered.sort((a,b) => {
          const field = sortState.field || 'name';
          const dir = sortState.dir === 'desc' ? -1 : 1;
          const va = normalizeSortVal(field, a);
          const vb = normalizeSortVal(field, b);
          if (va < vb) return -1 * dir;
          if (va > vb) return 1 * dir;
          return a.name.localeCompare(b.name);
        });

        const total = filtered.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (page > totalPages) page = totalPages;
        const start = (page - 1) * pageSize;
        const end = Math.min(start + pageSize, total);
        const pageItems = filtered.slice(start, end);

        tableBody.innerHTML = '';
        pageItems.forEach(p => {
          const tr = document.createElement('tr');
          const checkrStatus = p.checkr?.status || '';
          const watchStatus = p.watch?.status || '';
          const checkrType = checkrTypeLabel(p.checkr?.type || '');
          tr.innerHTML = `
            <td><input type="checkbox" class="form-check-input bw-row" data-email="${p.email}" ${selectedEmails.has(p.email) ? 'checked' : ''} /></td>
            <td>
              <div class="fw-semibold">${p.name}</div>
              <div class="small text-body-secondary">${p.email}</div>
            </td>
            <td class="d-none d-lg-table-cell">${p.program}</td>
            <td class="d-none d-xl-table-cell">${p.cohort ? p.cohort : '<span class="text-body-secondary">Unassigned</span>'}</td>
            <td>
              <div class="d-flex flex-wrap align-items-center gap-2">
                ${checkrStatus ? `<span class="badge text-bg-secondary">${checkrType || 'Checkr'}</span>` : '<span class="text-body-secondary">â€”</span>'}
                ${statusBadge(checkrStatus)}
              </div>
            </td>
            <td class="text-nowrap">${prettyDate(p.checkr?.modified || '')}</td>
            <td>
              <div class="d-flex flex-wrap align-items-center gap-2">
                ${statusBadge(watchStatus)}
              </div>
            </td>
            <td class="text-nowrap">${prettyDate(p.watch?.modified || '')}</td>
            <td class="text-end">
              <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm btn-cpnw dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Actions
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><button class="dropdown-item" type="button" data-action="initiate" data-email="${p.email}">Initiateâ€¦</button></li>
                  <li><button class="dropdown-item" type="button" data-action="clear" data-email="${p.email}">Clear</button></li>
                </ul>
              </div>
            </td>
          `;
          tableBody.appendChild(tr);
        });

        if (selectAll){
          const visibleEmails = pageItems.map(p => p.email);
          const visibleSelected = visibleEmails.filter(e => selectedEmails.has(e)).length;
          selectAll.indeterminate = visibleSelected > 0 && visibleSelected < visibleEmails.length;
          selectAll.checked = !!visibleEmails.length && visibleSelected === visibleEmails.length;
        }

        if (pageInfo){
          pageInfo.textContent = total ? `Showing ${start + 1}â€“${end} of ${total}` : 'No results';
        }
        if (prevBtn) prevBtn.disabled = page <= 1;
        if (nextBtn) nextBtn.disabled = end >= total;

        updateSelectionUI();
      }

      function refreshFromStore(){
        roster.forEach(p => {
          const record = getRecord(p.email);
          p.checkr = record.checkr;
          p.watch = record.watch;
        });
      }

      if (selectAll){
        selectAll.addEventListener('change', () => {
          const boxes = document.querySelectorAll('.bw-row');
          boxes.forEach(cb => {
            cb.checked = selectAll.checked;
            const email = cb.dataset.email;
            if (!email) return;
            if (selectAll.checked) selectedEmails.add(email);
            else selectedEmails.delete(email);
          });
          updateSelectionUI();
        });
      }

      tableBody?.addEventListener('change', (e) => {
        const cb = e.target.closest('input.bw-row');
        if (!cb) return;
        const email = cb.dataset.email;
        if (!email) return;
        if (cb.checked) selectedEmails.add(email);
        else selectedEmails.delete(email);
        updateSelectionUI();
      });

      tableBody?.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const action = btn.dataset.action;
        const email = btn.dataset.email;
        if (!email) return;
        if (action === 'initiate'){
          openInitiate([email], 'single');
        }else if (action === 'clear'){
          if (!window.confirm('Clear Checkr/WATCH status for this student?')) return;
          clearRecord(email);
          refreshFromStore();
          render();
        }
      });

      document.querySelectorAll('.sort').forEach(btn => {
        btn.addEventListener('click', () => {
          const field = btn.dataset.sort;
          if (!field) return;
          if (sortState.field === field){
            sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
          }else{
            sortState.field = field;
            sortState.dir = 'asc';
          }
          render();
        });
      });

      [searchInput, programSelect, cohortSelect, statusSelect].forEach(el => {
        if (!el) return;
        el.addEventListener('input', () => { page = 1; render(); });
        if (el.tagName === 'SELECT'){
          el.addEventListener('change', () => { page = 1; render(); });
        }
      });

      pageSizeSelect?.addEventListener('change', () => {
        pageSize = Number(pageSizeSelect.value || 10);
        page = 1;
        render();
      });
      prevBtn?.addEventListener('click', () => { page = Math.max(1, page - 1); render(); });
      nextBtn?.addEventListener('click', () => { page = page + 1; render(); });

      clearFiltersBtn?.addEventListener('click', () => {
        if (searchInput) searchInput.value = '';
        if (programSelect) programSelect.value = '';
        if (cohortSelect) cohortSelect.value = '';
        if (statusSelect) statusSelect.value = '';
        page = 1;
        render();
      });

      initiateSingleBtn?.addEventListener('click', () => {
        if (selectedEmails.size !== 1) return;
        openInitiate([Array.from(selectedEmails)[0]], 'single');
      });
      initiateGroupBtn?.addEventListener('click', () => {
        if (selectedEmails.size <= 1) return;
        openInitiate(Array.from(selectedEmails), 'group');
      });

      initiateCheckr?.addEventListener('change', () => {
        const enabled = !!initiateCheckr.checked;
        setCheckrTypeEnabled(enabled);
        if (enabled && checkrStandard) checkrStandard.checked = true;
      });

      confirmBtn?.addEventListener('click', () => {
        setInitiateError('');
        const emails = currentModalEmails.slice();
        if (!emails.length){
          setInitiateError('No students selected.');
          return;
        }
        if (currentModalMode === 'group' && emails.length < 2){
          setInitiateError('Group initiation requires at least 2 selected students.');
          return;
        }
        const doCheckr = !!initiateCheckr?.checked;
        const doWatch = !!initiateWatch?.checked;
        if (!doCheckr && !doWatch){
          setInitiateError('Select at least one check to initiate (Checkr and/or WATCH).');
          return;
        }
        const checkrType = doCheckr ? getActiveCheckrType() : '';
        if (doCheckr && !checkrType){
          setInitiateError('Select a Checkr type (Standard or International/Nonâ€‘SSN).');
          return;
        }
        const now = isoDate(new Date());
        emails.forEach(email => {
          const patch = {};
          if (doCheckr){
            patch.checkr = { type: checkrType, status: 'sent', modified: now };
          }
          if (doWatch){
            patch.watch = { status: 'sent', modified: now };
          }
          patchRecord(email, patch);
        });
        refreshFromStore();
        render();
        modal?.hide();
      });

      modalEl?.addEventListener('hidden.bs.modal', () => {
        currentModalEmails = [];
        currentModalMode = 'single';
        setInitiateError('');
      });

      render();
    })();
  </script>
</body>
</html>
